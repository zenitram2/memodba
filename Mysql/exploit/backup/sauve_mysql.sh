#!/bin/bash
#==============================================================================
#
# NOM
#      sauve_mysql.sh
#
# ********************************************************
# AUTEUR           : MEMODBA
# VERSION          : 1.01.04 
# DATE DE CREATION : 20141009
# ********************************************************
# DESCRIPTION
#      Script pour les versions MySQL 5.1, 5.5, 5.6
#      Sauvegarde des bases de données 
#
# USAGE
#      sauve_mysql.sh
#      en general a lancer une fois par jour
#      exemple de lancement par crontab 
#      0 * * * * /sauve/sauve_mysql.sh >> sauve_mysql.log 2>&1
#
#      Pour exclure des tables : --ignore-table=allegro_cirra.v_cirra_eval_apt_eval  --ignore-table=allegro_cirra.v_cirra_eval_apt_collab
#
# Emplacement
#		/sauve
#
# ********************************************************
# *                   MODIFICATIONS                      *
# *------------------------------------------------------*
# * Quand    | Qui   | Quoi                              *
# *------------------------------------------------------*
#  20141120  | MEMODBA | Ajout sonde passive centreon, pipefail
#  20141014  | MEMODBA   | Ajout consistance,routines,etc 
#  20141022  | MEMODBA   | Ajout des erreurs et du mode verbeux
#  20150127  | MEMODBA   | Ajout des exclusions de base et correction des erreurs
#  20150128  | MEMODBA   | Ajout de l'horodatage des sauvegardes
# ********************************************************
#==============================================================================

# configuration de la sauvegarde
backup_dir="/sauve/"
log="sauve_mysql_$(date +%Y%m%d%HH%M).txt"
retention=7
user="sauve"

#configuration de la sonde passive centreon
#nom du script et du serveur
script_name=$(basename "$0")
host_name=$(hostname -s)
#declaration des variables pour nagios/centreon
STATE_OK=0
STATE_WARNING=1
STATE_CRITICAL=2
STATE_UNKNOWN=3
state=${STATE_OK}
error_message="OK"
shopt -s extglob
exclude_database='+(performance_schema|test)'
# retourne erreur même avec un pipe
set -o pipefail

#Debut de la sauvegarde
echo "$(date +%H:%M:%S)  Debut de la sauvegarde" > "${backup_dir}${log}"

if [ ! -d "$backup_dir" ]; then
  mkdir -p "$backup_dir"
fi

for database in $(mysql -u  "$user" -Bse 'show databases') ; do
	case "$database" in
	   $exclude_database) 
			echo "$(date +%H:%M:%S)  La base ${database} a ete exclue de la sauvegarde" >> "${backup_dir}${log}"
			;;	   
	   *)
			mysqldump -u $user --log-error="${backup_dir}${log}" -f -v --routines --events --triggers -F --create-options --single-transaction  --databases "${database}"   | bzip2 -9 > "${backup_dir}${database}_full_$(date +%Y%m%d)".dmp.bz2			
			if [ $? != 0 ]; then
				echo "$(date +%H:%M:%S)  La sauvegarde de la base ${database} n'a pas fonctionne" >> "${backup_dir}${log}"
				state=${STATE_CRITICAL} 
				error_message="$error_message La sauvegarde de la base ${database} n'a pas fonctionne."
			else
				echo "$(date +%H:%M:%S)  Sauvegarde de la base ${database} OK" >> "${backup_dir}${log}"
				error_message="$error_message La sauvegarde de la base ${database} OK"
			fi
  esac

done

#Purge des vieux fichiers definis par la retention
echo "$(date +%H:%M:%S)  Purge des dumps vieux de plus de ${retention} jours" >> "${backup_dir}${log}"

find $backup_dir -name "*.dmp.bz2" -type f -prune -mtime +${retention} -exec rm -f {} \;
find $backup_dir -name "*.txt" -type f -prune -mtime +${retention} -exec rm -f {} \;

echo "$(date +%H:%M:%S)  Fin de traitement" >> "${backup_dir}${log}"

# envoi des informations à Centreon 
##echo -e "${host_name}\tcheck_script_sauve\t${state}\tstatut script tina dans /sauve/${script_name} ${error_message}" | /usr/local/overmon/nagios/libexec/send_nsca -H hostname -c /usr/local/overmon/nagios/etc/send_nsca.cfg
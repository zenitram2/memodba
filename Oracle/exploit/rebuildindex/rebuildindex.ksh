#!/bin/ksh
#==============================================================================
#
# NOM
#      rebuildindex.ksh
#
# ********************************************************
# AUTEUR           : MEMODBA
# VERSION          : 1.01.00 
# DATE DE CREATION : 20140909
# ********************************************************
# DESCRIPTION
#      Script pour les versions Oracle 11g
#      Rebuild des index  
#
# USAGE
#      rebuildindex.ksh
#      en general a lancer une fois par semaine
#      exemple de lancement par crontab 
#      0 * * * * /app/script/rebuildindex/rebuildindex.ksh >/app/script/rebuildindex/log/rebuildindex.log 2>&1
# Emplacement
#		/app/script/rebuildindex
#
# ********************************************************
# *                   MODIFICATIONS                      *
# *------------------------------------------------------*
# * Quand    | Qui | Quoi                                *
# *------------------------------------------------------*
#  20140909   MEMODBA    Creation
# ********************************************************
#==============================================================================

# ----------------------------------------------------------
#  chargement environnement
# ----------------------------------------------------------
.  `dirname $0`/rebuildindex.env

DBversion=0
# test variables sensibles non nulle

if [ -z "$LOGPATH"  ]
    then
echo "------------------------------------"> $REBUILDINDEX_LOG
echo "variable LOGPATH vide ">> $REBUILDINDEX_LOG
         exit
    fi

if [ -z "$REBUILDINDEX_LOG"  ]
    then
echo "------------------------------------"> $REBUILDINDEX_LOG
echo "variable REBUILDINDEX_LOG vide ">> $REBUILDINDEX_LOG
         exit
    fi


if [ -z "$MOIS"  ]
    then
echo "------------------------------------"> $REBUILDINDEX_LOG
echo "variable MOIS vide ">> $REBUILDINDEX_LOG
         exit
    fi



# test si base presente
type_mach=`uname`
if [ $type_mach = 'AIX' ] 
	then
nbr_pmon=` ps -ef | grep pmon_$ORACLE_SID| grep -cv grep`
else 
nbr_pmon=` ps -ef | grep pmon_$ORACLE_SID$| grep -cv grep`
fi 
  if [ $nbr_pmon -ne 1  ]
     then
echo "------------------------------------"> $REBUILDINDEX_LOG
echo " base $ORACLE_SID non presente ">> $REBUILDINDEX_LOG
           exit
     fi

sqlplus -s /nolog << EOF > $REBUILDINDEX_LOGTMP
connect / as sysdba
set head off pages 0 feed off lines 200
select substr(version, 1, instr(version, '.') -1 ) from v\$instance;
EOF
grep -v "Connect" $REBUILDINDEX_LOGTMP>$REBUILDINDEX_LOGTMP1

if [ `cat $REBUILDINDEX_LOGTMP | grep 'ORA-' | wc -l` -ne 0 ]
then
   exit 1
fi

DBversion=`cat $REBUILDINDEX_LOGTMP1`
export DBversion
rm -f $REBUILDINDEX_LOGTMP1 
rm -f $REBUILDINDEX_LOGTMP


#------------------------------LANCEMENT DU CALCUL DES STATISTIQUES-----------------------------------

echo "------------------------------------" > $REBUILDINDEX_LOG
echo $(date +"%d/%m/%Y:%H:%M:%S"):Lancement du rebuild des index >> $REBUILDINDEX_LOG

sqlplus -s /nolog << EOF >>$REBUILDINDEX_LOG
connect / as sysdba
set serveroutput on
set echo on feed on lines 200 head on timing on
exec  PERFSTAT.PKG_INDEX.rebuild;
EOF


#### test si ok
if [ `cat $REBUILDINDEX_LOG | grep 'ORA-' | wc -l` -ne 0 ]
  then
###### on conserve un an de log archive par mois
cat $REBUILDINDEX_LOG >> $REBUILDINDEX_LOG.$MOIS
      exit 1
  else
      echo $(date +"%d/%m/%Y:%H:%M:%S"):Fin du rebuild des index >> $REBUILDINDEX_LOG
###### on conserve un  an de log archive par mois
cat $REBUILDINDEX_LOG >> $REBUILDINDEX_LOG.$MOIS
  fi

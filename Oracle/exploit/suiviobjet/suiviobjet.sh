#!/bin/bash
#==============================================================================
#
# NOM
#      suiviobjet.sh
#
# ********************************************************
# AUTEUR           : MEMODBA
# VERSION          : 1.01.00 
# DATE DE CREATION : 20150518
# ********************************************************
# DESCRIPTION
#      Script pour les versions Oracle 10g et 11g
#      Suivi des objets de BDD  
#
# USAGE
#      purge_audit.ksh
#      en general a lancer une fois par jour
#      exemple de lancement par crontab 
#      0 * * * * /app/script/suiviobjet/suiviobjet.sh >/app/script/suiviobjet/log/suiviobjet.log 2>&1
# Emplacement
#		/app/script/suiviobjet
#
# ********************************************************
# *                   MODIFICATIONS                      *
# *------------------------------------------------------*
# * Quand    | Qui | Quoi                                *
# *------------------------------------------------------*
#  20150518   MEMODBA    Creation
# ********************************************************
#==============================================================================
DIR_IMP="/app/script/suiviobjet"
DIR_LOG="/app/script/suiviobjet/log"
export DateTraitement=$(date '+%y%m%d_%HH%M')
DATE_DEBUT=`date +%Y%m%d%H%M%S`
retention=30


. /home/dba/oracle/.bash_profile
. /home/dba/oracle/dbaoraenv.sh HOME

export LOG=${DIR_LOG}/Suivi_Objet_${ORACLE_SID}_${DateTraitement}.html
cat ${DIR_LOG}/suiviobjet.log >> ${DIR_LOG}/suiviobjet.old


echo "<html>" >> ${LOG}
echo "<body>" >> ${LOG}
echo "<style>" >> ${LOG}
echo "html{font-family:arial} " >> ${LOG}
echo "table{width:100%;font-family:arial;border:1px solid black;border-collapse:collapse;}" >> ${LOG}
echo "table tr th{background-color:#eeeeee;}" >> ${LOG}
echo ".error_msg{ color:#FF0000; font-weight:bold;}" >> ${LOG}
echo '.Listing	{mso-style-name:Listing;	mso-style-unhide:no;	mso-style-parent:"Texte 1";	mso-style-link:"Listing Car";	margin-top:0cm;	margin-right:0cm;	margin-bottom:0cm;		margin-bottom:.0001pt;	mso-pagination:widow-orphan lines-together;	tab-stops:3.0cm 99.25pt 4.0cm 127.6pt 5.0cm 155.95pt 6.0cm;	background:#FFFF99;	border:none;	mso-border-alt:solid windowtext .5pt;	padding:0cm;	mso-padding-alt:1.0pt 4.0pt 1.0pt 4.0pt;	font-size:8.0pt;	mso-bidi-font-size:10.0pt;	font-family:"Courier New";	mso-fareast-font-family:"Times New Roman";	mso-bidi-font-family:"Times New Roman";}'  >> ${LOG}

echo "</style>" >> ${LOG}

echo "<h1>Suivi des objets : "`date +%F`" " `date +%T`"</h1>" >> ${LOG}

echo "<h2>Suivi des tablespaces</h2>" >> ${LOG}
QUERY_OBJ=$(sqlplus -s -l / as sysdba <<EOF

SET MARKUP HTML ON SPOOL ON

set termout off
set verify off
set echo off
set feedback off

select df.tablespace_name "Tablespace",
totalusedspace "Used MB",
(df.totalspace - tu.totalusedspace) "Free MB",
df.totalspace "Total MB",
round(100 * ( (df.totalspace - tu.totalusedspace)/ df.totalspace))
"Pct. Free" from (select tablespace_name,round(sum(bytes) / 1048576) TotalSpace
from dba_data_files
group by tablespace_name) df,
(select round(sum(bytes)/(1024*1024)) totalusedspace, tablespace_name
from dba_segments
group by tablespace_name) tu
where df.tablespace_name = tu.tablespace_name 
order by totalusedspace desc ,df.tablespace_name;

SET MARKUP HTML OFF

exit
EOF
)

echo ${QUERY_OBJ} >> ${LOG}

echo "<h2>Suivi des segments</h2>" >> ${LOG}

QUERY_OBJ=$(sqlplus -s -l / as sysdba <<EOF

SET MARKUP HTML ON SPOOL ON

set termout off
set verify off
set echo off
set feedback off
set pagesize 49999
set head on

SELECT TABLESPACE_NAME TABLESPACE,OWNER,SEGMENT_NAME,PARTITION_NAME,ROUND(SUM(BYTES) /(1024*1024)) "USED MB", 
ROUND(SUM(BLOCKS)) BLOCKS,ROUND(SUM(EXTENTS)) EXTENTS
FROM DBA_SEGMENTS
WHERE TABLESPACE_NAME NOT IN('SYSTEM','SYSAUX','PERFSTAT','UNDOTBS1')
GROUP BY TABLESPACE_NAME,SEGMENT_NAME,PARTITION_NAME,OWNER
ORDER BY ROUND(SUM(BYTES) /(1024*1024)) DESC,TABLESPACE_NAME,OWNER,SEGMENT_NAME,PARTITION_NAME;
SET MARKUP HTML OFF

exit
EOF
)

echo ${QUERY_OBJ} >> ${LOG}


echo "Fin : "`date +%F`" " `date +%T` >> ${LOG}

# On nettoie
if [ `find ${DIR_LOG} -type f -prune -mtime +${retention} | wc -l` -ne 0 ] ; then
  echo -e "\n -> Suppression de tous les fichiers > ${retention} jours "
  for tmpfile in `find ${DIR_LOG} -name "*.*" -type f -prune -mtime +${retention}` ; do
    echo "-> Suppression du fichier $tmpfile" && rm -f $tmpfile 
  done
fi

echo "Log : "`date +%F`" " `date +%T` | mail -s "["`hostname`"]["$ORACLE_SID"]-Resultat Suivi Objet ${ORACLE_SID}" -a ${LOG} -r noreply@aveo-groupe.com MEMODBA@gmail.com

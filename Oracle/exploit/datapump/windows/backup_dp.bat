@echo off
REM |==============================================================================
REM |
REM | NOM
REM |      backup_db.bat
REM |
REM | ********************************************************
REM | AUTEUR           : MEMODBA
REM | VERSION          : 1.00.00 
REM | DATE DE CREATION : 20140512
REM | ********************************************************
REM | ********************************************************
REM | DESCRIPTION
REM |      Script pour les versions Oracle 10g, 11g
REM |      sauvegarde des bases oracle, 
REM |      et gestion de la retention des backups 
REM |
REM | USAGE
REM |      backup_db.bat
REM | Emplacement
REM |		d:/Sauve/
REM |
REM | ********************************************************
REM | *                   MODIFICATIONS                      *
REM | *------------------------------------------------------*
REM | * Quand    | Qui | Quoi                                *
REM | *------------------------------------------------------*
REM |
REM | ********************************************************
REM |==============================================================================


REM |--------------------------------------------------------------------------+
REM | TOOLS PARAMETERS                                             |
REM |--------------------------------------------------------------------------+
SET ARCHIVE_PROGRAM="C:\Program Files\7-Zip\7z.exe"

REM |--------------------------------------------------------------------------+
REM | VALIDATE ENVIRONMENT VARIABLES                                             |
REM |--------------------------------------------------------------------------+
set ORACLE_SID=PILADH


REM |--------------------------------------------------------------------------+
REM | DECLARE ALL GLOBAL VARIABLES.                                            |
REM |--------------------------------------------------------------------------+
SET DD=%date:~0,2%
SET MM=%date:~3,2%
SET YYYY=%date:~6,4%
SET T=%TIME: =0%

SET DUMPFILE_NAME=%ORACLE_SID%_FULL_%YYYY%%MM%%DD%%T:~0,2%%T:~3,2%00.dp
SET LOGFILE_NAME=%ORACLE_SID%_FULL_%YYYY%%MM%%DD%%T:~0,2%%T:~3,2%00.log
SET BACKUP_FILENAME=%ORACLE_SID%_FULL_%YYYY%%MM%%DD%%T:~0,2%%T:~3,2%00.zip


echo ...
echo Run Export Datapump

expdp '/ as sysdba' directory=dp_backup dumpfile=%DUMPFILE_NAME% logfile=%LOGFILE_NAME%  FULL=Y flashback_time=\"TO_TIMESTAMP(SYSDATE, 'DD/MM/YYYY HH24:MI:SS')\"


IF %ERRORLEVEL% NEQ 0 GOTO ERROR
echo Export Datapump termine

%ARCHIVE_PROGRAM% a -tzip %BACKUP_FILENAME% %DUMPFILE_NAME% %LOGFILE_NAME%
IF %ERRORLEVEL% NEQ 0 GOTO ERROR_ARCHIVE

DEL /q %DUMPFILE_NAME%
DEL /q %LOGFILE_NAME%

REM On nettoie tous les fichiers ZIP de plus de 7 jours
forfiles /p "d:\Sauve" /m *.zip /d -7 -c "cmd /c del @path"
IF %ERRORLEVEL% NEQ 0 echo Pas de sauvegarde a nettoyer


@echo on
EXIT 0

:ERROR
echo Export Datapump termine avec erreur
@echo on
EXIT 1

:ERROR_ARCHIVE
echo Probleme de generation du zip
@echo on
EXIT 1


#!/bin/bash
###################################################################################
# Script de sauvegarde des bases oracle, et gestion de la retention des backups
# 28/03/2013 Memodba
###################################################################################

export backup_dir="/sauve/"
retention=3
retentionCourte=1
script_username="oracle"
schemas='FULL'
sid='XXX1 XXXX2'

# tests pre-execution
if ( ! echo $script_username | grep `whoami` > /dev/null ) ; then
  echo -e "\n ERREUR : Ce script doit s'executer en tant que ${script_username}\n" && exit 1
fi

if [ ! -d $backup_dir ]; then
  mkdir -p $backup_dir
fi

###################################################################################
# Debut de traitement
echo -e "\n[`date`] Debut du traitement\n"

# Sauvegarde des bases
for bdd in ${sid}; do
  export ORACLE_SID=${bdd}
  export backup_file="${bdd}_FULL_`date +%Y%m%d%H%M`.dmp"
  cd ${backup_dir}
  echo -n " -> Sauvegarde de la base $bdd vers ${backup_file}"
  ####
  # Permet d'etre consistent
  #flashback_time=systimestamp
  #flashback_time=\"TO_TIMESTAMP\(SYSDATE, \'DD/MM/YYYY HH24:MI:SS\'\)\"
  #
  expdp userid=\"/ as sysdba\" DIRECTORY=DP_BACKUP DUMPFILE=${backup_file} LOGFILE=${backup_file}.log FULL=Y  flashback_time=systimestamp
  bzip2 ${backup_file} && echo " `ls -lh ${backup_file}.bz2| awk '{ print $5 }'` OK" ||( echo " KO" && exit 1 )
done

# On nettoie
if [ `find $backup_dir -type f -prune -mtime +${retention} | wc -l` -ne 0 ] ; then
  echo -e "\n -> Suppression de tous les backups > ${retention} jours "
  for tmpfile in `find $backup_dir -name "*.dmp.*" -type f -prune -mtime +${retention}` ; do
    echo "-> Suppression du fichier $tmpfile" && rm -f $tmpfile
  done
fi

# Fin de traitement
echo -e "\n[`date`] Fin du traitement\n"
exit 0
####################################################################################

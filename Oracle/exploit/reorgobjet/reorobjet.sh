#!/bin/bash

export DateTraitement=$(date '+%y%m%d_%HH%M')
DATE_DEBUT=`date +%Y%m%d%H%M%S`
DIR_LOG="/app/script/reorgobjet/log"

. /home/dba/oracle/.bash_profile
. /home/dba/oracle/dbaoraenv.sh HOME


echo "Reorganisation  objets : "`date +%F`" " `date +%T`" "   > ${DIR_LOG}/ReorgObj_${ORACLE_SID}_${DateTraitement}.html
echo " " >> ${DIR_LOG}/ReorgObj_${ORACLE_SID}_${DateTraitement}.html

QUERY_OBJ=$(sqlplus -s -l / as sysdba <<EOF

SET MARKUP HTML ON SPOOL ON

set termout off
set verify off
set echo off
set feedback off
set serveroutput on

Declare
Sreq  VARCHAR2(5000) ;
 cursor C1 is
 select table_name,owner,index_name from dba_indexes where table_name in ('F_EXTRAIP_DAY','F_EXTRAIP_WEEK','F_EXTRAIP_MONTH'); 
 begin
for I in C1 LOOP
dbms_output.put_line('==>');
dbms_output.put_line('Calcul des stats:'||i.table_name) ;
begin
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME =>i.owner,TABNAME =>i.table_name);
end ;

dbms_output.put_line('Reorganisation table: '||i.table_name) ;
Sreq:='alter table '||i.owner||'.'||i.table_name||' move ' ;
execute immediate Sreq ;
dbms_output.put_line('Rebuild index:'||i.index_name) ;
Sreq:='alter index '||i.owner||'.'||i.index_name||'  rebuild ' ;
execute immediate Sreq ;
dbms_output.put_line('Calcul des stats:'||i.table_name) ;
begin
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME =>i.owner,TABNAME =>i.table_name);
end ;

 END LOOP ;
END ;
/

SET MARKUP HTML OFF

exit
EOF
)
echo "" >> ${DIR_LOG}/ReorgObj_${ORACLE_SID}_${DateTraitement}.html

echo ${QUERY_OBJ} >> ${DIR_LOG}/ReorgObj_${ORACLE_SID}_${DateTraitement}.html




echo "Fin : "`date +%F`" " `date +%T` >> ${DIR_LOG}/ReorgObj_${ORACLE_SID}_${DateTraitement}.html


## echo 'Reorganisation tables : ' | mail -s "Resultat Reorganisation Objet ${ORACLE_SID}" -a ${DIR_LOG}/ReorgObj_${ORACLE_SID}_${DateTraitement}.html -r memodba@gmail.com xxxx@xxxx.xx



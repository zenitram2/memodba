@echo off
REM |--------------------------------------------------------------------------+
REM | DECLARE ALL GLOBAL VARIABLES.                                            |
REM |--------------------------------------------------------------------------+
SET DD=%date:~0,2%
SET MM=%date:~3,2%
SET YYYY=%date:~6,4%
SET T=%TIME: =0%
SET DATE_TRAITEMENT=%YYYY%%MM%%DD%%T:~0,2%%T:~3,2%00
SET BACKUP_FILENAME=%DATE_TRAITEMENT%
SET REP_BACKUP=g:\Backup
REM Recuperation du hostname
FOR /F "usebackq" %%i IN (`hostname`) DO SET HOST=%%i
SET NAS_DIRECTORY=\\SLNAS001P0\data\courant\%HOST%\
SET LOG_7ZIP=%REP_BACKUP%\LOG\LOG_7ZIP_%BACKUP_FILENAME%.log

REM |--------------------------------------------------------------------------+
REM | TOOLS PARAMETERS                                             |
REM |--------------------------------------------------------------------------+
SET ARCHIVE_PROGRAM="C:\7-Zip\7z.exe"

REM Debut du traitement
echo Debut de traitement de compression %DATE_TRAITEMENT%

REM Changement de repertoire
cd %REP_BACKUP%
REM Positionnement dans le repertoire de Backup
g:



@echo off
call :treeProcess
goto :eof

REM Fonction de parcours de dossier recursif pour la compression des backups en bzip2
:treeProcess


for %%f in (*.bak) do (
	REM Compression en bzip2 avec 7Zip
	%ARCHIVE_PROGRAM% a -tbzip2 %BACKUP_FILENAME%.dmp.bz2 %%f >%LOG_7ZIP% 2>&1
	IF %ERRORLEVEL% NEQ 0 GOTO ERROR_ARCHIVE

	rem On nettoie les fichiers backups
	DEL /q %%f

	rem On deplace vers le NAS
	move %BACKUP_FILENAME%.dmp.bz2 %NAS_DIRECTORY%
	IF %ERRORLEVEL% NEQ 0 GOTO ERROR_XCOPY

)

for /D %%d in (*) do (
    cd %%d
    SET BACKUP_FILENAME=%%d_%BACKUP_FILENAME%
    call :treeProcess	    
    cd ..
    SET BACKUP_FILENAME=%DATE_TRAITEMENT%
)
exit /b

REM Gestion des erreurs pour la compression
:ERROR_ARCHIVE
echo Probleme de generation du bzip
@echo on
EXIT 1

REM Gestion des erreurs pour la compression
:ERROR_XCOPY
echo Probleme de transfert sur le NAS
@echo on
EXIT 1